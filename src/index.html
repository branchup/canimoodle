<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Can I Moodle</title>
  <link href="styles.css" rel="stylesheet">
  <script src=https://unpkg.com/compare-versions/lib/umd/index.js></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>

<body class="py-8">
  <header class="mx-auto max-w-screen-md text-center mb-8">
    <h1 class="text-3xl mb-2">Can I Moodle?</h1>
    <p class="text-center">Features and compatibility across Moodle versions.</p>
  </header>
  <div class="max-w-screen-md mx-auto" x-data="state" x-init="$watch('filterTerm', () => updateFeatures())">
    <div class="my-4">
      <input type="text" class="px-4 py-2 text-xl w-full border-2 border-gray-100 rounded" placeholder="Filter..." x-model="filterTerm">
    </div>
    <div class="space-y-4">
      <template x-for="feature in features">
        <section class="rounded border border-gray-100 p-4" x-template>
          <div class="flex mb-4">
            <div class="grow">
              <h3 class="text-lg font-bold mb-4" x-text="feature.title">PHP 7.1</h3>
              <div class="space-y-4">
                <div x-html="feature.descriptionHtml" class="grow has-code-sm">
                  Compatibility with PHP 7.1.
                </div>
                <div x-html="feature.notesHtml" x-show="feature.notes" class="text-sm text-gray-700 has-code-xs"></div>
                <div x-show="feature.links && feature.links.length > 0">
                  <h4 class="font-bold text-base mb-2">Resources</h4>
                  <ul class="list-disc pl-6">
                    <template x-for="link in feature.links">
                      <li><a :href="link.url" x-text="link.title" class="text-blue-600 hover:underline"></a></li>
                    </template>
                  </ul>
                </div>
              </div>
            </div>
            <div class="shrink-0 pt-1">
              <div class="flex items-end gap-2 flex-col text-right text-sm">
                <div class="rounded bg-green-100 leading-none px-2 py-1">Added in <span class="font-bold" x-text="feature.added">3.11</span></div>
                <div class="rounded bg-yellow-100 leading-none px-2 py-1" x-show="feature.deprecated">Deprecated in <span class="font-bold" x-text="feature.deprecated">3.11</span></div>
                <div class="rounded bg-red-100 leading-none px-2 py-1" x-show="feature.removed">Removed in <span class="font-bold" x-text="feature.removed">4.4</span></div>
              </div>
            </div>
          </div>
          <div class="text-xs text-gray-500">Moodle version</div>
          <div class="grid grid-flow-col gap-0 text-center">
            <template x-for="version in versions">
              <div x-data="{ compat: getCompatibility(`${feature.added}`, `${feature.removed ?? ''}`, `${feature.deprecated ?? ''}`, `${version}`) }">
                <div class="p-0.5" x-text="version" :class="{'bg-green-300': compat == true, 'bg-red-300': !compat, 'bg-amber-200': compat == 'deprecated'}">3.11</div>
              </div>
            </template>
          </div>
        </section>
      </template>
    </div>
  </div>
  <script id="versions-json" type="application/json">
    ["3.11", "4.0", "4.1", "4.2", "4.3", "4.4", "4.5"]
  </script>
  <script id="features-json" type="application/json">
    [{
      "title": "PHP 7.3",
      "description": "Compatibility with PHP 7.3.",
      "added": "3.11",
      "removed": "4.1"
    }]
  </script>
  <script>
    const {
      compareVersions,
      compare
    } = window.compareVersions;
    const VERSIONS = JSON.parse(document.getElementById('versions-json').textContent);
    const FEATURES = JSON.parse(document.getElementById('features-json').textContent).map(feature => ({
      ...feature,
      descriptionHtml: (feature.description ?? '').replace(/`([^`]+)`/g, '<code>$1</code>'),
      notesHtml: (feature.notes ?? '').replace(/`([^`]+)`/g, '<code>$1</code>')
    }));
    document.addEventListener('alpine:init', () => {
      Alpine.data('state', () => ({
        features: FEATURES,
        versions: VERSIONS,
        filterTerm: '',
        updateFeatures() {
          console.log('aaa');
          if (!this.filterTerm) {
            this.features = FEATURES;
            return;
          }
          this.features = FEATURES.filter(feature => {
            return feature.title.toLowerCase().includes(this.filterTerm.toLowerCase()) ||
              feature.description.toLowerCase().includes(this.filterTerm.toLowerCase());
          });
        },
        getCompatibility(added, removed, deprecated, version) {
          const isMet = compare(version, added, '>=');
          const isRemoved = removed && compare(version, removed, '>=');
          const isDeprecated = deprecated && compare(version, deprecated, '>=');
          if (!isMet) {
            return false;
          }
          if (isDeprecated) {
            return 'deprecated';
          }
          return !isRemoved;
        },
      }));
    });
  </script>
</body>

</html>